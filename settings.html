<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Settings - Monthly Goal</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
body {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  height: 100vh;
  margin: 0;
  background-color: #dedede;
  font-family: 'Share Tech Mono', monospace;
}
#hamburger {
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 30px;
  cursor: pointer;
  user-select: none;
}
#nav-menu {
  position: absolute;
  top: 50px;
  right: 10px;
  background-color: rgba(255, 255, 255, 0.9);
  border: 1px solid #ccc;
  padding: 10px;
  display: none;
  font-size: 1.2em;
}
#nav-menu.open {
  display: block;
}
#nav-menu a {
  display: block;
  text-decoration: none;
  color: #333;
  margin: 5px 0;
}
#slider-container {
  margin-top: 20px;
}
#goal-label[contenteditable] {
  display: inline-block;
  min-width: 6ch;
  padding: 2px 4px;
  border: 1px dashed transparent;
}
#goal-label[contenteditable]:focus {
  outline: none;
  border-color: #666;
  background-color: #fff;
}
#goals-table {
  border-collapse: collapse;
  margin-top: 20px;
}
#goals-table th,
#goals-table td {
  border: 1px solid #ccc;
  padding: 4px 8px;
}
#goals-table input {
  width: 100px;
}
</style>
</head>
<body>
<div id="hamburger">&#9776;</div>
<div id="nav-menu">
  <a href="index.html">Home</a>
  <a href="#">Stats</a>
  <a href="settings.html">Settings</a>
</div>
<section id="api-section">
  <h2>API endpoints</h2>
  <div id="api-list"></div>
  <button id="add-api">+ Add API</button>
  <button id="save-apis">OK</button>
</section>
<h1>Monthly goals</h1>
<table id="goals-table">
  <tr><th>Month</th><th>Goal</th></tr>
  <tr><td>January 2025</td><td><input data-key="2025-01" type="text" placeholder="fill in"></td></tr>
  <tr><td>February 2025</td><td><input data-key="2025-02" type="text" placeholder="fill in"></td></tr>
  <tr><td>March 2025</td><td><input data-key="2025-03" type="text" placeholder="fill in"></td></tr>
  <tr><td>April 2025</td><td><input data-key="2025-04" type="text" placeholder="fill in"></td></tr>
  <tr><td>May 2025</td><td><input data-key="2025-05" type="text" placeholder="fill in"></td></tr>
  <tr><td>June 2025</td><td><input data-key="2025-06" type="text" placeholder="fill in"></td></tr>
  <tr><td>July 2025</td><td><input data-key="2025-07" type="text" placeholder="fill in"></td></tr>
  <tr><td>August 2025</td><td><input data-key="2025-08" type="text" placeholder="fill in"></td></tr>
  <tr><td>September 2025</td><td><input data-key="2025-09" type="text" placeholder="fill in"></td></tr>
  <tr><td>October 2025</td><td><input data-key="2025-10" type="text" placeholder="fill in"></td></tr>
  <tr><td>November 2025</td><td><input data-key="2025-11" type="text" placeholder="fill in"></td></tr>
  <tr><td>December 2025</td><td><input data-key="2025-12" type="text" placeholder="fill in"></td></tr>
</table>
<div id="slider-container">
  <label for="goal-slider">Monthly goal:</label>
  <input type="range" id="goal-slider" min="100000" max="1000000" step="1000">
  <span id="goal-label" contenteditable="true"></span>
</div>
<script>
const slider = document.getElementById('goal-slider');
const goalLabel = document.getElementById('goal-label');
const hamburger = document.getElementById('hamburger');
const navMenu = document.getElementById('nav-menu');

const apiList = document.getElementById('api-list');
const addApiBtn = document.getElementById('add-api');
const saveApisBtn = document.getElementById('save-apis');
let apis = JSON.parse(localStorage.getItem('counterApis') || '[]');

if (!apis.length) {
  const old1 = localStorage.getItem('counterUrl1');
  const old2 = localStorage.getItem('counterUrl2');
  if (old1) apis.push({ name: 'API 1', url: old1 });
  if (old2) apis.push({ name: 'API 2', url: old2 });
}
if (!apis.length) apis = [{ name: 'API 1', url: '' }, { name: 'API 2', url: '' }];

function renderApiList() {
  apiList.innerHTML = '';
  apis.forEach((api, idx) => {
    const div = document.createElement('div');
    div.innerHTML = `<input class="api-url" placeholder="URL" type="text"> ` +
                    `<input class="api-name" placeholder="Name" type="text"> ` +
                    `<button class="remove-api">x</button>`;
    const urlInput = div.querySelector('.api-url');
    const nameInput = div.querySelector('.api-name');
    urlInput.value = api.url;
    nameInput.value = api.name;
    div.querySelector('.remove-api').addEventListener('click', () => {
      apis.splice(idx, 1);
      renderApiList();
    });
    apiList.appendChild(div);
  });
}

addApiBtn.addEventListener('click', () => {
  apis.push({ name: '', url: '' });
  renderApiList();
});

saveApisBtn.addEventListener('click', () => {
  apis = Array.from(apiList.children).map(row => ({
    url: row.querySelector('.api-url').value.trim(),
    name: row.querySelector('.api-name').value.trim()
  })).filter(a => a.url);
  localStorage.setItem('counterApis', JSON.stringify(apis));
  localStorage.removeItem('counterUrl1');
  localStorage.removeItem('counterUrl2');
  renderApiList();
});

renderApiList();
const now = new Date();
// Use the same YYYY-MM key as the main page
const monthKey = now.toISOString().slice(0,7);
// Retrieve stored month goals from localStorage
const monthlyGoals = JSON.parse(localStorage.getItem('monthlyGoals') || '{}');
// Default goal if none exists yet
let monthlyGoal = Number(monthlyGoals[monthKey]) || 500000;

function updateGoalDisplay() {
  goalLabel.textContent = monthlyGoal.toLocaleString();
}

hamburger.addEventListener('click', () => {
  navMenu.classList.toggle('open');
});

slider.value = monthlyGoal;
updateGoalDisplay();

slider.addEventListener('input', () => {
  monthlyGoal = Number(slider.value);
  updateGoalDisplay();
  // Persist the slider value for this month
  monthlyGoals[monthKey] = monthlyGoal;
  localStorage.setItem('monthlyGoals', JSON.stringify(monthlyGoals));
});

goalLabel.addEventListener('blur', () => {
  const digits = goalLabel.textContent.replace(/[^0-9]/g, '');
  const value = Number(digits);
  if (!isNaN(value) && value >= 100000 && value <= 1000000) {
    monthlyGoal = value;
    slider.value = value;
  }
  updateGoalDisplay();
  // Save goal after manual edit
  monthlyGoals[monthKey] = monthlyGoal;
  localStorage.setItem('monthlyGoals', JSON.stringify(monthlyGoals));
});

document.querySelectorAll('#goals-table input').forEach(input => {
  const key = input.dataset.key;
  if (monthlyGoals[key]) {
    input.value = monthlyGoals[key].toLocaleString();
  }
  input.addEventListener('blur', () => {
    const digits = input.value.replace(/[^0-9]/g, '');
    const val = Number(digits);
    if (!isNaN(val) && val >= 100000 && val <= 1000000) {
      // Keep each month's value separate
      monthlyGoals[key] = val;
      if (key === monthKey) {
        monthlyGoal = val;
        slider.value = val;
        updateGoalDisplay();
      }
      input.value = val.toLocaleString();
    } else {
      input.value = monthlyGoals[key] ? monthlyGoals[key].toLocaleString() : '';
    }
      // Save the table value back to localStorage
      localStorage.setItem('monthlyGoals', JSON.stringify(monthlyGoals));
    });
  });
</script>
</body>
</html>
